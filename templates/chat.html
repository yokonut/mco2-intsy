<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap" rel="stylesheet">
  <title>Ask me questions!</title>
</head>

<body
  style="margin:0; background-color:#FFF5EE; font-family:'Comfortaa', cursive; overflow:hidden; height:100vh; color:#572542;">

  <!-- Title -->
  <h1 style="font-size: 2.5rem; font-weight: bold; text-align: center; margin-top: 20px; margin-bottom: 20px;">
    ChatBunny
  </h1>

  <!-- Message display log -->
  <div id="contents" class="hidden flex flex-col items-center pt-[10vh] gap-6 px-4 max-h-[65vh] overflow-y-auto">
    <!-- Messages will be appended here -->
  </div>

  <!-- Chat input form -->
  <div id="answer-form" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
              border-radius: 90px; overflow: hidden; display: flex; justify-content: center; align-items: center;
              box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); ">
    <form onsubmit="handleSubmit(event)" style="background-color: #fff; padding: 20px; border-radius: 40px;
                 box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); display: flex; gap: 20px; align-items: center;">
      <input type="text" id="user-question" name="query" placeholder="Ask/tell me anything!"
        style="padding: 20px; font-size: 24px; width: 1200px; outline: none;">
      <input type="image" src="{{ url_for('static', filename='img/submit-bunny.png') }}" alt="Send with Bunny Magic"
        style="width: 80px; height: 80px; border: none; cursor: pointer;">
    </form>
  </div>

  <!-- JavaScript -->
  <script>
    function typeWriter(text, element, speed = 40) {
      element.innerHTML = "";
      let i = 0;
      function type() {
        if (i < text.length) {
          if (text.charAt(i) === '\n') {
            element.innerHTML += '<br>';
          } else {
            element.innerHTML += text.charAt(i);
          }
          i++;
          setTimeout(type, speed);
        }
      }
      type();
    }

    function createBubble(content, color) {
      const bubble = document.createElement("div");
      bubble.className = `rounded-full px-6 py-4 text-lg w-[1200px]`;
      bubble.style.backgroundColor = color;
      bubble.style.whiteSpace = 'pre-line'; // Preserve line breaks
      bubble.textContent = content;
      return bubble;
    }

    function handleSubmit(event) {
      event.preventDefault();

      const question = document.getElementById("user-question").value;
      const contents = document.getElementById("contents");
      contents.classList.remove("hidden");

      fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `query=${encodeURIComponent(question)}`
      })
        .then(response => response.json())
        .then(data => {
          contents.innerHTML = ""; // Reset and rebuild log

          data.log.forEach((msg, index) => {
            const userBubble = createBubble(msg.user, "#FABABB");
            const botBubble = createBubble("", "#FFD3DA");
            contents.appendChild(userBubble);
            contents.appendChild(botBubble);

            if (index === data.log.length - 1) {
              typeWriter(msg.bot, botBubble);
            } else {
              botBubble.textContent = msg.bot;
            }
          });
        });

      document.getElementById("user-question").value = "";
    }
  </script>

</body>

</html>